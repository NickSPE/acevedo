{% extends 'core/auth_base.html' %}

{% block title %}Recuperar Contrase√±a - FinGest{% endblock %}

{% block nav_links %}
    <a href="{% url 'usuarios:login' %}" class="text-gray-600 hover:text-emerald-600 transition-colors">
        Volver al Login
    </a>
{% endblock %}

{% block content %}
<div class="w-full max-w-md mx-auto p-4">
    <div class="bg-white rounded-2xl shadow-2xl p-8">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-900 mb-2">üîê Recuperar Contrase√±a</h1>
            <p class="text-gray-600">Sigue los pasos para recuperar tu acceso</p>
        </div>

        <!-- Barra de progreso -->
        <div class="mb-8">
            <div class="flex justify-between text-sm text-gray-500 mb-2">
                <span id="step-label-1" class="font-medium text-emerald-600">1. Email</span>
                <span id="step-label-2" class="text-gray-400">2. C√≥digo</span>
                <span id="step-label-3" class="text-gray-400">3. Nueva Contrase√±a</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2">
                <div id="progress-bar" class="bg-gradient-to-r from-emerald-600 to-teal-600 h-2 rounded-full transition-all duration-300" style="width: 33%"></div>
            </div>
        </div>

        <!-- PASO 1: Solicitar c√≥digo -->
        <div id="step-1" class="step active">
            <h3 class="text-xl font-semibold text-gray-800 mb-4 text-center">
                üìß Ingresa tu email
            </h3>
            
            <form id="form-email">
                {% csrf_token %}
                <div class="mb-4">
                    <label for="email" class="block text-sm font-medium text-gray-700 mb-2">
                        Correo electr√≥nico
                    </label>
                    <input type="email" 
                           id="email" 
                           name="email" 
                           required 
                           placeholder="tu@email.com"
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition-colors">
                </div>
                
                <button type="submit" 
                        id="btn-solicitar"
                        class="w-full bg-gradient-to-r from-emerald-600 to-emerald-700 text-white py-3 px-4 rounded-lg hover:from-emerald-700 hover:to-emerald-800 focus:ring-4 focus:ring-emerald-200 transition-all duration-200 font-medium shadow-lg">
                    üì® Enviar C√≥digo de Verificaci√≥n
                </button>
            </form>

            <div id="message-step1" class="mt-4 p-3 rounded-lg hidden"></div>
        </div>

        <!-- PASO 2: Verificar c√≥digo -->
        <div id="step-2" class="step">
            <h3 class="text-xl font-semibold text-gray-800 mb-4 text-center">
                üî¢ Ingresa el c√≥digo
            </h3>
            
            <div class="text-center mb-4">
                <p class="text-sm text-gray-600">
                    Se envi√≥ un c√≥digo de 6 d√≠gitos a:
                </p>
                <p class="font-medium text-emerald-600" id="email-display"></p>
            </div>
            
            <form id="form-codigo">
                {% csrf_token %}
                <input type="hidden" id="email-hidden" name="email" value="">
                
                <div class="mb-4">
                    <label for="codigo" class="block text-sm font-medium text-gray-700 mb-2">
                        C√≥digo de verificaci√≥n
                    </label>
                    <input type="text" 
                           id="codigo" 
                           name="codigo" 
                           required 
                           maxlength="6"
                           pattern="[0-9]{6}"
                           placeholder="123456"
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition-colors text-center text-2xl font-mono tracking-widest">
                </div>
                
                <button type="submit" 
                        id="btn-verificar"
                        class="w-full bg-gradient-to-r from-emerald-600 to-emerald-700 text-white py-3 px-4 rounded-lg hover:from-emerald-700 hover:to-emerald-800 focus:ring-4 focus:ring-emerald-200 transition-all duration-200 font-medium shadow-lg">
                    ‚úÖ Verificar C√≥digo
                </button>
            </form>

            <div id="message-step2" class="mt-4 p-3 rounded-lg hidden"></div>
            
            <div class="text-center mt-4">
                <button id="btn-volver-email" 
                        class="text-emerald-600 hover:text-emerald-800 text-sm">
                    ‚Üê Cambiar email
                </button>
            </div>
        </div>

        <!-- PASO 3: Nueva contrase√±a -->
        <div id="step-3" class="step">
            <h3 class="text-xl font-semibold text-gray-800 mb-4 text-center">
                üîí Nueva contrase√±a
            </h3>
            
            <div class="text-center mb-4">
                <p class="text-sm text-emerald-600">
                    ‚úÖ C√≥digo verificado correctamente
                </p>
            </div>
            
            <form id="form-password">
                {% csrf_token %}
                <input type="hidden" id="email-final" name="email" value="">
                <input type="hidden" id="codigo-final" name="codigo" value="">
                
                <div class="mb-4">
                    <label for="nueva_password" class="block text-sm font-medium text-gray-700 mb-2">
                        Nueva contrase√±a
                    </label>
                    <div class="relative">
                        <input type="password" 
                               id="nueva_password" 
                               name="nueva_password" 
                               required 
                               minlength="8"
                               placeholder="M√≠nimo 8 caracteres seguros"
                               class="w-full px-4 py-3 pr-12 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition-colors">
                        <button type="button" 
                                id="toggle-password-1"
                                class="absolute inset-y-0 right-0 pr-3 flex items-center">
                            <svg class="h-5 w-5 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                            </svg>
                        </button>
                    </div>
                </div>
                
                <div class="mb-6">
                    <label for="confirmar_password" class="block text-sm font-medium text-gray-700 mb-2">
                        Confirmar nueva contrase√±a
                    </label>
                    <input type="password" 
                           id="confirmar_password" 
                           name="confirmar_password" 
                           required 
                           minlength="8"
                           placeholder="Repite la contrase√±a"
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition-colors">
                    <div id="password-match" class="text-sm mt-1 hidden"></div>
                </div>
                
                <button type="submit" 
                        id="btn-cambiar"
                        class="w-full bg-gradient-to-r from-green-600 to-green-700 text-white py-3 px-4 rounded-lg hover:from-green-700 hover:to-green-800 focus:ring-4 focus:ring-green-200 transition-all duration-200 font-medium shadow-lg">
                    üîê Cambiar Contrase√±a
                </button>
            </form>

            <div id="message-step3" class="mt-4 p-3 rounded-lg hidden"></div>
        </div>

        <!-- PASO 4: √âxito -->
        <div id="step-4" class="step">
            <div class="text-center">
                <div class="mb-6">
                    <div class="inline-flex items-center justify-center w-16 h-16 bg-green-100 rounded-full mb-4">
                        <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                        </svg>
                    </div>
                    <h3 class="text-2xl font-bold text-gray-900 mb-2">¬°Contrase√±a Actualizada!</h3>
                    <p class="text-gray-600 mb-6">Tu contrase√±a ha sido cambiada exitosamente.</p>
                </div>
                
                <a href="{% url 'usuarios:login' %}" 
                   class="w-full inline-block bg-gradient-to-r from-emerald-600 to-emerald-700 text-white py-3 px-4 rounded-lg hover:from-emerald-700 hover:to-emerald-800 transition-all duration-200 font-medium shadow-lg text-center">
                    Iniciar Sesi√≥n
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .step { display: none; }
    .step.active { display: block; }
</style>
{% endblock %}

{% block extra_js %}
<script>
let currentStep = 1;
let userEmail = '';
let verificationCode = '';

// Funci√≥n para cambiar de paso
function showStep(step) {
    document.querySelectorAll('.step').forEach(el => el.classList.remove('active'));
    document.getElementById(`step-${step}`).classList.add('active');
    
    // Actualizar barra de progreso
    const progress = (step / 4) * 100;
    document.getElementById('progress-bar').style.width = `${progress}%`;
    
    // Actualizar labels
    document.querySelectorAll('[id^="step-label-"]').forEach((el, index) => {
        if (index + 1 <= step) {
            el.classList.remove('text-gray-400');
            el.classList.add('text-emerald-600', 'font-medium');
        } else {
            el.classList.remove('text-emerald-600', 'font-medium');
            el.classList.add('text-gray-400');
        }
    });
    
    currentStep = step;
}

// Funci√≥n para mostrar mensaje
function showMessage(stepId, message, isError = false) {
    const messageDiv = document.getElementById(`message-step${stepId}`);
    messageDiv.className = `mt-4 p-3 rounded-lg ${isError ? 'bg-red-100 text-red-700 border border-red-200' : 'bg-green-100 text-green-700 border border-green-200'}`;
    messageDiv.textContent = message;
    messageDiv.classList.remove('hidden');
    
    // Auto-ocultar despu√©s de 5 segundos si es √©xito
    if (!isError) {
        setTimeout(() => {
            messageDiv.classList.add('hidden');
        }, 5000);
    }
}

// PASO 1: Enviar c√≥digo
document.getElementById('form-email').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const email = document.getElementById('email').value.trim();
    const btn = document.getElementById('btn-solicitar');
    
    if (!email) {
        showMessage(1, 'Por favor ingresa tu email', true);
        return;
    }
    
    btn.disabled = true;
    btn.innerHTML = '‚è≥ Enviando c√≥digo...';
    
    try {
        const formData = new FormData();
        formData.append('email', email);
        formData.append('action', 'send_code');
        formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
        
        const response = await fetch('{% url "usuarios:password_reset_request" %}', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
            userEmail = email;
            document.getElementById('email-display').textContent = email;
            document.getElementById('email-hidden').value = email;
            showMessage(1, data.message);
            
            setTimeout(() => {
                showStep(2);
            }, 2000);
        } else {
            showMessage(1, data.message, true);
        }
    } catch (error) {
        showMessage(1, 'Error de conexi√≥n. Int√©ntalo de nuevo.', true);
        console.error('Error:', error);
    }
    
    btn.disabled = false;
    btn.innerHTML = 'üì® Enviar C√≥digo de Verificaci√≥n';
});

// PASO 2: Verificar c√≥digo
document.getElementById('form-codigo').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const codigo = document.getElementById('codigo').value.trim();
    const btn = document.getElementById('btn-verificar');
    
    if (!codigo || codigo.length !== 6) {
        showMessage(2, 'Ingresa un c√≥digo de 6 d√≠gitos', true);
        return;
    }
    
    btn.disabled = true;
    btn.innerHTML = '‚è≥ Verificando...';
    
    try {
        const formData = new FormData();
        formData.append('email', userEmail);
        formData.append('codigo', codigo);
        formData.append('action', 'verify_code');
        formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
        
        const response = await fetch('{% url "usuarios:password_reset_request" %}', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
            verificationCode = codigo;
            document.getElementById('email-final').value = userEmail;
            document.getElementById('codigo-final').value = codigo;
            showMessage(2, data.message);
            
            setTimeout(() => {
                showStep(3);
            }, 2000);
        } else {
            showMessage(2, data.message, true);
        }
    } catch (error) {
        showMessage(2, 'Error de conexi√≥n. Int√©ntalo de nuevo.', true);
        console.error('Error:', error);
    }
    
    btn.disabled = false;
    btn.innerHTML = '‚úÖ Verificar C√≥digo';
});

// PASO 3: Cambiar contrase√±a
document.getElementById('form-password').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const password1 = document.getElementById('nueva_password').value;
    const password2 = document.getElementById('confirmar_password').value;
    const btn = document.getElementById('btn-cambiar');
    
    if (password1.length < 8) {
        showMessage(3, 'La contrase√±a debe tener al menos 8 caracteres', true);
        return;
    }
    
    if (password1 !== password2) {
        showMessage(3, 'Las contrase√±as no coinciden', true);
        return;
    }
    
    btn.disabled = true;
    btn.innerHTML = '‚è≥ Cambiando contrase√±a...';
    
    try {
        const formData = new FormData();
        formData.append('email', userEmail);
        formData.append('codigo', verificationCode);
        formData.append('nueva_password', password1);
        formData.append('action', 'reset_password');
        formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
        
        const response = await fetch('{% url "usuarios:password_reset_request" %}', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
            showStep(4);
        } else {
            showMessage(3, data.message, true);
        }
    } catch (error) {
        showMessage(3, 'Error de conexi√≥n. Int√©ntalo de nuevo.', true);
        console.error('Error:', error);
    }
    
    btn.disabled = false;
    btn.innerHTML = 'üîê Cambiar Contrase√±a';
});

// Validaci√≥n en tiempo real de confirmaci√≥n de contrase√±a
document.getElementById('confirmar_password').addEventListener('input', function() {
    const password1 = document.getElementById('nueva_password').value;
    const password2 = this.value;
    const matchDiv = document.getElementById('password-match');
    
    if (password2.length > 0) {
        if (password1 === password2) {
            matchDiv.textContent = '‚úÖ Las contrase√±as coinciden';
            matchDiv.className = 'text-sm mt-1 text-green-600';
            matchDiv.classList.remove('hidden');
        } else {
            matchDiv.textContent = '‚ùå Las contrase√±as no coinciden';
            matchDiv.className = 'text-sm mt-1 text-red-600';
            matchDiv.classList.remove('hidden');
        }
    } else {
        matchDiv.classList.add('hidden');
    }
});

// Bot√≥n volver al email
document.getElementById('btn-volver-email').addEventListener('click', function() {
    showStep(1);
});

// Toggle contrase√±a
document.getElementById('toggle-password-1').addEventListener('click', function() {
    const passwordInput = document.getElementById('nueva_password');
    const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
    passwordInput.setAttribute('type', type);
});
</script>
{% endblock %}
