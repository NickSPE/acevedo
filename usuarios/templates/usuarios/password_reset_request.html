<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recuperar Contrase√±a - FinGest</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .step-hidden { display: none; }
        .step-visible { display: block; }
        .codigo-input {
            text-align: center;
            font-size: 24px;
            font-weight: bold;
            letter-spacing: 8px;
            font-family: 'Courier New', monospace;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-800 mb-2">üîê Recuperar Contrase√±a</h1>
            <p class="text-gray-600">Recupera el acceso a tu cuenta FinGest</p>
        </div>

        <!-- Mensajes -->
        {% if messages %}
            {% for message in messages %}
                <div class="mb-4 p-3 rounded-lg {% if message.tags == 'error' %}bg-red-100 text-red-700 border border-red-200{% elif message.tags == 'success' %}bg-green-100 text-green-700 border border-green-200{% else %}bg-blue-100 text-blue-700 border border-blue-200{% endif %}">
                    {{ message }}
                </div>
            {% endfor %}
        {% endif %}

        <!-- Formulario Principal -->
        <div class="bg-white rounded-2xl shadow-xl p-8 max-w-md mx-auto">
            
            <!-- PASO 1: Solicitar c√≥digo -->
            <div id="step-1" class="step-visible">
                <h3 class="text-xl font-semibold text-gray-800 mb-4 text-center">
                    üìß Paso 1: Ingresa tu email
                </h3>
                
                <form id="form-solicitar-codigo" class="space-y-4">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="solicitar_codigo">
                    
                    <div>
                        <label for="email" class="block text-sm font-medium text-gray-700 mb-2">
                            Correo Electr√≥nico
                        </label>
                        <input type="email" 
                               id="email" 
                               name="email" 
                               required 
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                               placeholder="tu@correo.com">
                    </div>

                    <button type="submit" 
                            id="btn-solicitar-codigo"
                            class="w-full bg-blue-600 text-white py-3 px-4 rounded-lg hover:bg-blue-700 focus:ring-4 focus:ring-blue-200 transition-all duration-200 font-medium">
                        üì® Obtener C√≥digo
                    </button>
                </form>
            </div>

            <!-- PASO 2: Ingresar c√≥digo y nueva contrase√±a -->
            <div id="step-2" class="step-hidden">
                <h3 class="text-xl font-semibold text-gray-800 mb-4 text-center">
                    üî¢ Paso 2: C√≥digo enviado a tu email
                </h3>
                
                <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-6">
                    <p class="text-green-700 text-sm text-center">
                        ‚úÖ C√≥digo enviado a: <span id="email-sent" class="font-semibold"></span>
                    </p>
                    <p class="text-green-600 text-xs text-center mt-1">
                        Revisa tu bandeja de entrada (y spam)
                    </p>
                </div>

                <form id="form-cambiar-password" class="space-y-4">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="cambiar_password">
                    <input type="hidden" id="email-hidden" name="email" value="">
                    
                    <div>
                        <label for="codigo" class="block text-sm font-medium text-gray-700 mb-2">
                            üî¢ C√≥digo de 6 d√≠gitos
                        </label>
                        <input type="text" 
                               id="codigo" 
                               name="codigo" 
                               required 
                               maxlength="6"
                               pattern="[0-9]{6}"
                               class="codigo-input w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                               placeholder="123456">
                    </div>
                    
                    <div>
                        <label for="nueva_password" class="block text-sm font-medium text-gray-700 mb-2">
                            üîí Nueva Contrase√±a
                        </label>
                        <input type="password" 
                               id="nueva_password" 
                               name="nueva_password" 
                               required 
                               minlength="8"
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                               placeholder="M√≠nimo 8 caracteres seguros">
                        
                        <!-- Indicador de fortaleza de contrase√±a -->
                        <div id="password-strength" class="mt-2 hidden">
                            <div class="text-xs text-gray-600 mb-1">Fortaleza de la contrase√±a:</div>
                            <div class="flex space-x-1 mb-2">
                                <div id="strength-bar-1" class="h-2 w-full bg-gray-200 rounded"></div>
                                <div id="strength-bar-2" class="h-2 w-full bg-gray-200 rounded"></div>
                                <div id="strength-bar-3" class="h-2 w-full bg-gray-200 rounded"></div>
                                <div id="strength-bar-4" class="h-2 w-full bg-gray-200 rounded"></div>
                            </div>
                            <div id="strength-text" class="text-xs"></div>
                        </div>
                        
                        <!-- Requisitos de contrase√±a -->
                        <div id="password-requirements" class="mt-2 space-y-1 text-xs">
                            <div id="req-length" class="flex items-center text-gray-500">
                                <span class="w-4 h-4 mr-2">‚≠ï</span>
                                Al menos 8 caracteres
                            </div>
                            <div id="req-uppercase" class="flex items-center text-gray-500">
                                <span class="w-4 h-4 mr-2">‚≠ï</span>
                                Una letra may√∫scula (A-Z)
                            </div>
                            <div id="req-lowercase" class="flex items-center text-gray-500">
                                <span class="w-4 h-4 mr-2">‚≠ï</span>
                                Una letra min√∫scula (a-z)
                            </div>
                            <div id="req-number" class="flex items-center text-gray-500">
                                <span class="w-4 h-4 mr-2">‚≠ï</span>
                                Un n√∫mero (0-9)
                            </div>
                            <div id="req-special" class="flex items-center text-gray-500">
                                <span class="w-4 h-4 mr-2">‚≠ï</span>
                                Un car√°cter especial (!@#$%^&*)
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <label for="confirmar_password" class="block text-sm font-medium text-gray-700 mb-2">
                            üîí Confirmar Contrase√±a
                        </label>
                        <input type="password" 
                               id="confirmar_password" 
                               name="confirmar_password" 
                               required 
                               minlength="8"
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                               placeholder="Repite la contrase√±a">
                        <div id="password-match" class="text-sm mt-1 hidden"></div>
                    </div>

                    <button type="submit" 
                            id="btn-cambiar-password"
                            class="w-full bg-green-600 text-white py-3 px-4 rounded-lg hover:bg-green-700 focus:ring-4 focus:ring-green-200 transition-all duration-200 font-medium">
                        ‚úÖ Cambiar Contrase√±a
                    </button>
                </form>
                
                <div class="text-center mt-4">
                    <button id="btn-volver-step1" 
                            class="text-blue-600 hover:text-blue-800 text-sm">
                        ‚Üê Cambiar email o solicitar nuevo c√≥digo
                    </button>
                </div>
            </div>

            <!-- Enlaces adicionales -->
            <div class="text-center mt-6 space-y-2">
                <div>
                    <a href="{% url 'usuarios:login' %}" 
                       class="text-gray-600 hover:text-gray-800 text-sm">
                        ‚Üê Volver al login
                    </a>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Elementos
        const step1 = document.getElementById('step-1');
        const step2 = document.getElementById('step-2');
        const formSolicitar = document.getElementById('form-solicitar-codigo');
        const formCambiar = document.getElementById('form-cambiar-password');
        const btnVolverStep1 = document.getElementById('btn-volver-step1');
        const emailInput = document.getElementById('email');
        const emailSent = document.getElementById('email-sent');
        const emailHidden = document.getElementById('email-hidden');
        const codigoInput = document.getElementById('codigo');
        const nuevaPasswordInput = document.getElementById('nueva_password');
        const confirmarPasswordInput = document.getElementById('confirmar_password');

        // Funci√≥n para mostrar step 2
        function mostrarStep2(email) {
            step1.classList.add('step-hidden');
            step1.classList.remove('step-visible');
            step2.classList.add('step-visible');
            step2.classList.remove('step-hidden');
            emailSent.textContent = email;
            emailHidden.value = email;
        }

        // Funci√≥n para volver a step 1
        function volverStep1() {
            step2.classList.add('step-hidden');
            step2.classList.remove('step-visible');
            step1.classList.add('step-visible');
            step1.classList.remove('step-hidden');
            
            // Limpiar campos
            formCambiar.reset();
        }

        // Solicitar c√≥digo
        formSolicitar.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const email = emailInput.value.trim();
            if (!email) {
                alert('Por favor ingresa tu email');
                return;
            }

            const btnSolicitar = document.getElementById('btn-solicitar-codigo');
            btnSolicitar.disabled = true;
            btnSolicitar.textContent = 'üì® Enviando...';

            try {
                const formData = new FormData(formSolicitar);
                const response = await fetch('{% url "usuarios:password_reset_request" %}', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });

                const data = await response.json();
                
                if (data.success) {
                    alert(data.message);
                    mostrarStep2(email);
                } else {
                    alert(data.error || 'Error al enviar c√≥digo. Verifica tu email.');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error de conexi√≥n. Int√©ntalo de nuevo.');
            } finally {
                btnSolicitar.disabled = false;
                btnSolicitar.textContent = 'üì® Obtener C√≥digo';
            }
        });

        // Cambiar contrase√±a
        formCambiar.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const email = emailHidden.value;
            const codigo = codigoInput.value.trim();
            const nuevaPassword = nuevaPasswordInput.value;
            const confirmarPassword = confirmarPasswordInput.value;

            // Validaciones
            if (!codigo || codigo.length !== 6) {
                alert('El c√≥digo debe tener exactamente 6 d√≠gitos');
                return;
            }

            if (nuevaPassword !== confirmarPassword) {
                alert('Las contrase√±as no coinciden');
                return;
            }

            if (nuevaPassword.length < 6) {
                alert('La contrase√±a debe tener al menos 6 caracteres');
                return;
            }

            const btnCambiar = document.getElementById('btn-cambiar-password');
            btnCambiar.disabled = true;
            btnCambiar.textContent = '‚úÖ Cambiando...';

            try {
                const formData = new FormData(formCambiar);
                
                const response = await fetch('{% url "usuarios:password_reset_request" %}', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });

                const data = await response.json();
                
                if (data.success) {
                    alert('¬°Contrase√±a cambiada exitosamente!');
                    window.location.href = '{% url "usuarios:login" %}';
                } else {
                    alert(data.error || 'Error al cambiar contrase√±a.');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error de conexi√≥n. Int√©ntalo de nuevo.');
            } finally {
                btnCambiar.disabled = false;
                btnCambiar.textContent = '‚úÖ Cambiar Contrase√±a';
            }
        });

        // Validaciones en tiempo real
        codigoInput.addEventListener('input', function(e) {
            this.value = this.value.replace(/[^0-9]/g, '').slice(0, 6);
        });

        confirmarPasswordInput.addEventListener('input', function(e) {
            const password = nuevaPasswordInput.value;
            const confirm = this.value;
            
            if (confirm && password !== confirm) {
                this.setCustomValidity('Las contrase√±as no coinciden');
            } else {
                this.setCustomValidity('');
            }
        });

        // Volver a step 1
        btnVolverStep1.addEventListener('click', volverStep1);
    </script>
</body>
</html>
