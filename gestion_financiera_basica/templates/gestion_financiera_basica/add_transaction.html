{% extends 'core/base_template.html' %}

{% block title %}Nueva Transacción | FinGest{% endblock %}

{% block content %}
<div class="max-w-md mx-auto">
  <!-- Header -->
  <div class="flex items-center justify-between mb-6">
    <div>
      <h1 class="text-2xl font-semibold text-gray-900">Nueva transacción</h1>
      <p class="text-gray-500 text-sm mt-1">Registra un nuevo movimiento</p>
    </div>
    <a href="{% url 'gestion_financiera_basica:transactions' %}" class="text-gray-400 hover:text-gray-600 transition-colors">
      <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
      </svg>
    </a>
  </div>

  <!-- Formulario -->
  <div class="bg-white rounded-lg border border-gray-200 p-6">
    <form method="post" class="space-y-6">
      {% csrf_token %}
      <!-- Tipo de transacción -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-3">Tipo de transacción</label>
        {% if form.tipo.errors %}
          <div class="mb-3 p-3 bg-red-50 border border-red-200 rounded-lg">
            <p class="text-red-600 text-sm">{{ form.tipo.errors.0 }}</p>
          </div>
        {% endif %}
        <div class="grid grid-cols-2 gap-3">
          {% for choice in form.tipo.field.choices %}
            {% if choice.0 %}
            <label class="relative cursor-pointer">
              <input type="radio" name="tipo" value="{{ choice.0 }}" 
                     class="peer sr-only" {% if form.tipo.value == choice.0 %}checked{% endif %}>
              <div class="flex items-center p-3 border-2 border-gray-200 rounded-lg peer-checked:border-gray-900 peer-checked:bg-gray-50 hover:border-gray-300 transition-colors">
                {% if choice.0 == 'ingreso' %}
                  <div class="w-8 h-8 bg-green-100 text-green-600 rounded-lg flex items-center justify-center mr-3">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 11l5-5m0 0l5 5m-5-5v12"/>
                    </svg>
                  </div>
                  <div>
                    <span class="font-medium text-gray-900">Ingreso</span>
                    <p class="text-xs text-gray-500">Dinero que entra</p>
                  </div>
                {% else %}
                  <div class="w-8 h-8 bg-red-100 text-red-600 rounded-lg flex items-center justify-center mr-3">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 13l-5 5m0 0l-5-5m5 5V6"/>
                    </svg>
                  </div>
                  <div>
                    <span class="font-medium text-gray-900">Gasto</span>
                    <p class="text-xs text-gray-500">Dinero que sale</p>
                  </div>
                {% endif %}
              </div>
            </label>
            {% endif %}
          {% endfor %}
        </div>
      </div>

      <!-- Nombre de la transacción -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">Descripción</label>
        {% if form.nombre.errors %}
          <div class="mb-3 p-3 bg-red-50 border border-red-200 rounded-lg">
            <p class="text-red-600 text-sm">{{ form.nombre.errors.0 }}</p>
          </div>
        {% endif %}
        <input type="text" name="nombre" value="{{ form.nombre.value|default:'' }}" 
               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-500 focus:border-gray-500 text-gray-900"
               placeholder="Ej: Salario, Supermercado, Cine..." required>
      </div>

      <!-- Monto y Cuenta -->
      <div class="grid grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Monto</label>
          {% if form.monto.errors %}
            <div class="mb-3 p-3 bg-red-50 border border-red-200 rounded-lg">
              <p class="text-red-600 text-sm">{{ form.monto.errors.0 }}</p>
            </div>
          {% endif %}
          <div class="relative">
            <span class="absolute left-3 top-2.5 text-gray-500">$</span>
            <input type="number" name="monto" value="{{ form.monto.value|default:'' }}" 
                   class="w-full pl-8 pr-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-500 focus:border-gray-500 text-gray-900"
                   placeholder="0.00" step="0.01" min="0" required>
          </div>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Cuenta</label>
          {% if form.id_cuenta.errors %}
            <div class="mb-3 p-3 bg-red-50 border border-red-200 rounded-lg">
              <p class="text-red-600 text-sm">{{ form.id_cuenta.errors.0 }}</p>
            </div>
          {% endif %}
          <select name="id_cuenta" 
                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-500 focus:border-gray-500 text-gray-900" required>
            <option value="">Seleccionar</option>
            {% for choice in form.id_cuenta.field.choices %}
              <option value="{{ choice.0 }}" {% if form.id_cuenta.value == choice.0 %}selected{% endif %}>{{ choice.1 }}</option>
            {% endfor %}
          </select>
        </div>
      </div>

      <!-- Categoría -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">Categoría (opcional)</label>
        {% if form.categoria.errors %}
          <div class="mb-3 p-3 bg-red-50 border border-red-200 rounded-lg">
            <p class="text-red-600 text-sm">{{ form.categoria.errors.0 }}</p>
          </div>
        {% endif %}
        <select name="categoria" id="id_categoria"
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-500 focus:border-gray-500 text-gray-900">
          <option value="">Seleccionar categoría</option>
          <option value="alimentacion">Alimentación</option>
          <option value="transporte">Transporte</option>
          <option value="entretenimiento">Entretenimiento</option>
          <option value="salud">Salud</option>
          <option value="educacion">Educación</option>
          <option value="compras">Compras</option>
          <option value="servicios">Servicios</option>
          <option value="vivienda">Vivienda</option>
          <option value="trabajo">Trabajo</option>
          <option value="otros">Otros</option>
        </select>
      </div>

      <!-- Fecha -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">Fecha</label>
        {% if form.fecha_movimiento.errors %}
          <div class="mb-3 p-3 bg-red-50 border border-red-200 rounded-lg">
            <p class="text-red-600 text-sm">{{ form.fecha_movimiento.errors.0 }}</p>
          </div>
        {% endif %}
        <input type="date" name="fecha_movimiento" value="{{ form.fecha_movimiento.value|default:'' }}"
               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-500 focus:border-gray-500 text-gray-900" required>
      </div>

      <!-- Descripción -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">Descripción (opcional)</label>
        {% if form.descripcion.errors %}
          <div class="mb-3 p-3 bg-red-50 border border-red-200 rounded-lg">
            <p class="text-red-600 text-sm">{{ form.descripcion.errors.0 }}</p>
          </div>
        {% endif %}
        <textarea name="descripcion" rows="2" 
                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-500 focus:border-gray-500 resize-none text-gray-900"
                  placeholder="Detalles adicionales...">{{ form.descripcion.value|default:'' }}</textarea>
      </div>

      <!-- Botones -->
      <div class="flex gap-3 pt-2">
        <a href="{% url 'gestion_financiera_basica:transactions' %}" 
           class="flex-1 px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg font-medium transition-colors text-center">
          Cancelar
        </a>
        <button type="submit" 
                class="flex-1 px-4 py-2 bg-gray-900 hover:bg-gray-800 text-white rounded-lg font-medium transition-colors">
          Guardar transacción
        </button>
      </div>
    </form>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Establecer fecha actual por defecto
  const fechaInput = document.querySelector('input[name="fecha_movimiento"]');
  if (fechaInput && !fechaInput.value) {
    const today = new Date().toISOString().split('T')[0];
    fechaInput.value = today;
  }

  // Categorías dinámicas según el tipo
  const categorias = {
    'egreso': [
      ['alimentacion', 'Alimentación'],
      ['transporte', 'Transporte'],
      ['entretenimiento', 'Entretenimiento'],
      ['salud', 'Salud'],
      ['educacion', 'Educación'],
      ['compras', 'Compras'],
      ['servicios', 'Servicios'],
      ['vivienda', 'Vivienda'],
      ['otros', 'Otros']
    ],
    'ingreso': [
      ['salario', 'Salario'],
      ['freelance', 'Freelance'],
      ['negocio', 'Negocio'],
      ['inversion', 'Inversión'],
      ['regalo', 'Regalo'],
      ['otros', 'Otros']
    ]
  };

  function updateCategorias(tipo) {
    const categoriaSelect = document.getElementById('id_categoria');
    if (!categoriaSelect) return;
    
    const valorActual = categoriaSelect.value;
    categoriaSelect.innerHTML = '<option value="">Seleccionar categoría</option>';
    
    if (categorias[tipo]) {
      categorias[tipo].forEach(([value, text]) => {
        const option = document.createElement('option');
        option.value = value;
        option.textContent = text;
        categoriaSelect.appendChild(option);
      });
    }
    
    if (valorActual && categorias[tipo] && categorias[tipo].some(([value]) => value === valorActual)) {
      categoriaSelect.value = valorActual;
    }
  }

  // Escuchar cambios en el tipo de movimiento
  const tipoRadios = document.querySelectorAll('input[name="tipo"]');
  tipoRadios.forEach(radio => {
    radio.addEventListener('change', function() {
      if (this.checked) {
        updateCategorias(this.value);
      }
    });
  });

  // Inicializar categorías
  const tipoSeleccionado = document.querySelector('input[name="tipo"]:checked');
  if (tipoSeleccionado) {
    updateCategorias(tipoSeleccionado.value);
  } else {
    updateCategorias('egreso');
  }
});
</script>
{% endblock %}
