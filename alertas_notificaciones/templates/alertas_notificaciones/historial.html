{% extends "core/base_template.html" %}
{% block title %}Historial de Notificaciones | BuilderQuantum{% endblock %}

{% block extra_head %}
<style>
  .notification-item {
    transition: all 0.2s ease-in-out;
  }
  
  .notification-item:hover {
    transform: scale(1.01);
  }

  .notification-actions {
    opacity: 0;
    transition: opacity 0.2s ease;
  }

  .notification-item:hover .notification-actions {
    opacity: 1;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateX(-20px); }
    to { opacity: 1; transform: translateX(0); }
  }

  .notification-item {
    animation: fadeIn 0.3s ease-out forwards;
  }

  /* Checkbox personalizado */
  .custom-checkbox {
    @apply w-5 h-5 border-2 rounded flex items-center justify-center;
    @apply transition-colors duration-200;
  }

  .custom-checkbox.checked {
    @apply bg-blue-600 border-blue-600;
  }

  /* Datepicker personalizado */
  .date-input {
    @apply pl-8;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%236B7280'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z'%3E%3C/path%3E%3C/svg%3E");
    background-position: 0.5rem center;
    background-repeat: no-repeat;
    background-size: 1.25rem;
  }
</style>
{% endblock %}

{% block content %}
<div x-data="{
    notifications: [
      {
        id: 1,
        type: 'critical',
        title: 'Fondos Insuficientes',
        message: 'Tu cuenta principal tiene un saldo bajo de S/50.00, por debajo del l√≠mite establecido.',
        timestamp: new Date(Date.now() - 5 * 60 * 1000),
        category: 'Saldo',
        read: false,
        selected: false
      },
      {
        id: 2,
        type: 'warning',
        title: 'Presupuesto Excedido',
        message: 'Has superado el 90% de tu presupuesto en la categor√≠a Alimentaci√≥n.',
        timestamp: new Date(Date.now() - 2 * 60 * 60 * 1000),
        category: 'Presupuesto',
        read: false,
        selected: false
      },
      {
        id: 3,
        type: 'info',
        title: 'Meta Alcanzada',
        message: '¬°Felicidades! Has completado tu meta de ahorro para Vacaciones.',
        timestamp: new Date(Date.now() - 6 * 60 * 60 * 1000),
        category: 'Metas',
        read: true,
        selected: false
      }
    ],
    filters: {
      type: 'all',
      timeframe: '30',
      category: 'all',
      searchQuery: '',
      startDate: '',
      endDate: ''
    },
    selectedCount: 0,
    showCustomDateRange: false,
    selectAll: false,

    init() {
      this.$watch('notifications', value => {
        this.selectedCount = value.filter(n => n.selected).length;
        this.selectAll = value.length > 0 && value.every(n => n.selected);
      });
    },

    toggleSelectAll() {
      this.selectAll = !this.selectAll;
      this.notifications.forEach(n => n.selected = this.selectAll);
    },

    toggleRead(id) {
      const notification = this.notifications.find(n => n.id === id);
      if (notification) {
        notification.read = !notification.read;
      }
    },

    dismiss(id) {
      this.notifications = this.notifications.filter(n => n.id !== id);
    },

    dismissSelected() {
      this.notifications = this.notifications.filter(n => !n.selected);
    },

    markSelectedAsRead() {
      this.notifications.forEach(n => {
        if (n.selected) n.read = true;
      });
    },

    getRelativeTime(timestamp) {
      const now = new Date();
      const diffInMinutes = Math.floor((now - timestamp) / (1000 * 60));

      if (diffInMinutes < 1) return 'hace un momento';
      if (diffInMinutes < 60) return `hace ${diffInMinutes} min`;

      const diffInHours = Math.floor(diffInMinutes / 60);
      if (diffInHours < 24) return `hace ${diffInHours}h`;

      const diffInDays = Math.floor(diffInHours / 24);
      if (diffInDays < 7) return `hace ${diffInDays}d`;

      return timestamp.toLocaleDateString();
    },

    filteredNotifications() {
      return this.notifications.filter(n => {
        // Filtro por tipo
        if (this.filters.type !== 'all' && n.type !== this.filters.type) return false;
        
        // Filtro por categor√≠a
        if (this.filters.category !== 'all' && n.category.toLowerCase() !== this.filters.category) return false;
        
        // Filtro por tiempo
        const now = new Date();
        const notificationDate = new Date(n.timestamp);
        
        if (this.filters.timeframe === 'custom') {
          if (this.filters.startDate && this.filters.endDate) {
            const start = new Date(this.filters.startDate);
            const end = new Date(this.filters.endDate);
            return notificationDate >= start && notificationDate <= end;
          }
        } else {
          const daysAgo = this.filters.timeframe === '1' ? 1 : 
                         this.filters.timeframe === '7' ? 7 : 30;
          const cutoff = new Date(now - daysAgo * 24 * 60 * 60 * 1000);
          if (notificationDate < cutoff) return false;
        }
        
        // B√∫squeda por texto
        if (this.filters.searchQuery) {
          const query = this.filters.searchQuery.toLowerCase();
          return n.title.toLowerCase().includes(query) || 
                 n.message.toLowerCase().includes(query) ||
                 n.category.toLowerCase().includes(query);
        }
        
        return true;
      });
    }
  }"
  x-init="init"
>
  <!-- Navigation component -->
  <nav class="mb-6">
    <ul class="flex gap-4 border-b pb-2 text-sm font-medium">
      <li>
        <a href="{% url 'configuraciones' %}" class="hover:text-blue-600">
          ‚öôÔ∏è Configuraciones
        </a>
      </li>
      <li>
        <a href="{% url 'alertas_automaticas' %}" class="hover:text-blue-600">
          ‚ö° Alertas Autom√°ticas
        </a>
      </li>
      <li>
        <a href="{% url 'historial' %}" class="hover:text-blue-600 text-blue-600 border-b-2 border-blue-600 pb-1">
          üìú Historial
        </a>
      </li>
    </ul>
  </nav>

  <div class="max-w-5xl mx-auto">
    <!-- Header y Filtros -->
    <div class="bg-white p-6 rounded-lg shadow-lg mb-6">
      <div class="flex items-center justify-between mb-6">
        <div class="flex items-center gap-4">
          <h2 class="text-xl font-bold">Historial de notificaciones</h2>
          <span class="text-sm text-gray-500">
            <span x-text="filteredNotifications().length"></span> notificaciones encontradas
          </span>
        </div>
        <div class="flex items-center gap-3">
          <!-- Acciones en lote -->
          <template x-if="selectedCount > 0">
            <div class="flex items-center gap-2 px-3 py-1.5 bg-gray-100 rounded-lg">
              <span class="text-sm text-gray-600" x-text="`${selectedCount} seleccionadas`"></span>
              <button 
                @click="markSelectedAsRead"
                class="text-sm text-blue-600 hover:text-blue-700">
                Marcar como le√≠das
              </button>
              <div class="w-px h-4 bg-gray-300"></div>
              <button 
                @click="dismissSelected"
                class="text-sm text-red-600 hover:text-red-700">
                Eliminar
              </button>
            </div>
          </template>

          <!-- Bot√≥n marcar todas -->
          <button 
            class="text-sm text-gray-600 hover:text-gray-900 flex items-center gap-1"
            @click="notifications.forEach(n => n.read = true)">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
            </svg>
            Marcar todas como le√≠das
          </button>
        </div>
      </div>
      
      <div class="grid gap-4 md:grid-cols-2 lg:grid-cols-4">
        <!-- B√∫squeda -->
        <div class="relative">
          <input 
            type="text" 
            x-model="filters.searchQuery"
            placeholder="Buscar notificaciones..." 
            class="w-full pl-10 pr-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400 absolute left-3 top-2.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
          </svg>
        </div>
        
        <!-- Filtro por tipo -->
        <select 
          x-model="filters.type"
          class="w-full border rounded-lg p-2 text-sm bg-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
          <option value="all">Todos los tipos</option>
          <option value="critical">Cr√≠ticas</option>
          <option value="warning">Advertencias</option>
          <option value="info">Informativas</option>
        </select>
        
        <!-- Filtro por tiempo -->
        <select 
          x-model="filters.timeframe"
          class="w-full border rounded-lg p-2 text-sm bg-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
          <option value="30">√öltimos 30 d√≠as</option>
          <option value="7">√öltimos 7 d√≠as</option>
          <option value="1">Hoy</option>
          <option value="custom">Rango personalizado</option>
        </select>
        
        <!-- Filtro por categor√≠a -->
        <select 
          x-model="filters.category"
          class="w-full border rounded-lg p-2 text-sm bg-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
          <option value="all">Todas las categor√≠as</option>
          <option value="saldo">Saldo</option>
          <option value="presupuesto">Presupuesto</option>
          <option value="metas">Metas</option>
          <option value="prestamos">Pr√©stamos</option>
        </select>
      </div>

      <!-- Rango de fechas personalizado -->
      <div 
        x-show="filters.timeframe === 'custom'"
        x-transition:enter="transition ease-out duration-200"
        x-transition:enter-start="opacity-0 transform -translate-y-2"
        x-transition:enter-end="opacity-100 transform translate-y-0"
        class="grid grid-cols-2 gap-4 mt-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Fecha inicial</label>
          <input 
            type="date" 
            x-model="filters.startDate"
            class="w-full border rounded-lg p-2 text-sm date-input focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Fecha final</label>
          <input 
            type="date" 
            x-model="filters.endDate"
            class="w-full border rounded-lg p-2 text-sm date-input focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
        </div>
      </div>
    </div>

    <!-- Lista de Notificaciones -->
    <div class="space-y-4">
      <!-- Selector m√∫ltiple -->
      <div class="flex items-center gap-3 px-4 py-2 bg-white rounded-lg shadow mb-2">
        <label class="flex items-center gap-2 text-sm text-gray-600">
          <div 
            @click="toggleSelectAll"
            :class="{'checked': selectAll}"
            class="custom-checkbox border-gray-300 cursor-pointer">
            <svg x-show="selectAll" class="w-3 h-3 text-white" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M10 3L4.5 8.5L2 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </div>
          Seleccionar todas
        </label>
      </div>

      <!-- Notificaciones -->
      <template x-for="notification in filteredNotifications()" :key="notification.id">
        <div 
          :class="{
            'notification-item group relative p-4 rounded-lg border-l-4 shadow-lg': true,
            'border-l-red-500 bg-red-50 dark:bg-red-950/50': notification.type === 'critical',
            'border-l-orange-500 bg-orange-50 dark:bg-orange-950/50': notification.type === 'warning',
            'border-l-blue-500 bg-blue-50 dark:bg-blue-950/50': notification.type === 'info',
            'ring-2 ring-blue-200 dark:ring-blue-800': !notification.read
          }">
          <!-- Indicador no le√≠do -->
          <div 
            x-show="!notification.read"
            class="absolute top-2 right-2 w-2 h-2 bg-blue-500 rounded-full">
          </div>

          <div class="flex items-start gap-3">
            <!-- Checkbox -->
            <div class="flex-shrink-0 mt-1">
              <div 
                @click="notification.selected = !notification.selected"
                :class="{'checked': notification.selected}"
                class="custom-checkbox border-gray-300 cursor-pointer">
                <svg x-show="notification.selected" class="w-3 h-3 text-white" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M10 3L4.5 8.5L2 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </div>
            </div>

            <!-- Icono de tipo -->
            <div class="flex-shrink-0 mt-1">
              <template x-if="notification.type === 'critical'">
                <svg class="h-4 w-4 text-red-500" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </template>
              <template x-if="notification.type === 'warning'">
                <svg class="h-4 w-4 text-orange-500" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </template>
              <template x-if="notification.type === 'info'">
                <svg class="h-4 w-4 text-blue-500" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </template>
            </div>
            
            <div class="flex-1 min-w-0">
              <div class="flex items-center gap-2 mb-1">
                <h4 
                  :class="{'font-semibold': !notification.read, 'font-medium': notification.read}"
                  class="text-gray-900 dark:text-gray-100"
                  x-text="notification.title">
                </h4>
                <span 
                  :class="{
                    'inline-flex items-center rounded-full px-2 py-0.5 text-xs font-medium': true,
                    'bg-red-100 text-red-800': notification.type === 'critical',
                    'bg-orange-100 text-orange-800': notification.type === 'warning',
                    'bg-blue-100 text-blue-800': notification.type === 'info'
                  }"
                  x-text="notification.type === 'critical' ? 'Cr√≠tico' : notification.type === 'warning' ? 'Advertencia' : 'Info'">
                </span>
              </div>
              
              <p 
                :class="{'font-medium': !notification.read}"
                class="text-sm text-gray-600 mb-3 line-clamp-2"
                x-text="notification.message">
              </p>
              
              <div class="flex items-center gap-4 text-xs text-gray-500">
                <span class="flex items-center gap-1">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                  </svg>
                  <span x-text="getRelativeTime(notification.timestamp)"></span>
                </span>
                <span class="inline-flex items-center rounded-full border px-2 py-0.5 text-xs font-medium text-gray-600"
                      x-text="notification.category">
                </span>
                <span class="hidden sm:block" x-text="new Date(notification.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})"></span>
              </div>
            </div>

            <!-- Acciones -->
            <div class="notification-actions flex items-center gap-1 ml-4">
              <button 
                @click="toggleRead(notification.id)"
                class="h-8 w-8 p-0 rounded-lg hover:bg-gray-100"
                :title="notification.read ? 'Marcar como no le√≠da' : 'Marcar como le√≠da'">
                <template x-if="notification.read">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21" />
                  </svg>
                </template>
                <template x-if="!notification.read">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                  </svg>
                </template>
              </button>

              <button class="h-8 px-2 text-xs rounded-lg hover:bg-gray-100 flex items-center gap-1">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                </svg>
                <span x-text="notification.type === 'critical' ? 'Ver cuenta' : notification.type === 'warning' ? 'Ver presupuesto' : 'Ver detalles'"></span>
              </button>

              <button 
                @click="dismiss(notification.id)"
                class="h-8 w-8 p-0 rounded-lg text-red-500 hover:text-red-700 hover:bg-red-50" 
                title="Eliminar notificaci√≥n">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
              </button>
            </div>
          </div>
        </div>
      </template>

      <!-- Estado vac√≠o -->
      <template x-if="filteredNotifications().length === 0">
        <div class="text-center py-12">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto text-gray-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4" />
          </svg>
          <h3 class="text-lg font-medium text-gray-900 mb-2">No hay notificaciones</h3>
          <p class="text-gray-500">No se encontraron notificaciones que coincidan con los filtros aplicados.</p>
        </div>
      </template>
    </div>

    <!-- Paginaci√≥n -->
    <div class="mt-8 flex justify-between items-center">
      <div class="text-sm text-gray-500">
        Mostrando <span x-text="filteredNotifications().length"></span> notificaciones
      </div>
      
      <button class="text-blue-600 hover:text-blue-700 text-sm font-medium flex items-center gap-2">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
        </svg>
        Cargar m√°s notificaciones
      </button>
    </div>
  </div>
</div>
{% endblock %}
