{% extends "core/base_template.html" %}
{% block title %}Calculadoras Financieras | FinGest{% endblock %}

{% block content %}
<div class="mb-6">
  <h2 class="text-3xl font-bold text-gray-800 mb-2">üßÆ Calculadoras Financieras</h2>
  <p class="text-gray-600">Herramientas avanzadas para planificar tus finanzas con explicaciones de IA</p>
</div>

<!-- Navegaci√≥n de Tabs Mejorada -->
<div class="mb-8">
  <div class="flex flex-wrap gap-2 bg-gray-100 p-2 rounded-xl">
    <a href="{% url 'educacion_financiera:calculators' %}?tab=savings" 
       class="flex items-center gap-2 px-4 py-3 rounded-lg transition-all {% if tab == 'savings' %}bg-white shadow-md text-blue-600 font-semibold{% else %}text-gray-600 hover:bg-gray-200{% endif %}">
      üí∞ Ahorros
    </a>
    <a href="{% url 'educacion_financiera:calculators' %}?tab=loan" 
       class="flex items-center gap-2 px-4 py-3 rounded-lg transition-all {% if tab == 'loan' %}bg-white shadow-md text-blue-600 font-semibold{% else %}text-gray-600 hover:bg-gray-200{% endif %}">
      üè¶ Pr√©stamos
    </a>
    <a href="{% url 'educacion_financiera:calculators' %}?tab=budget" 
       class="flex items-center gap-2 px-4 py-3 rounded-lg transition-all {% if tab == 'budget' %}bg-white shadow-md text-blue-600 font-semibold{% else %}text-gray-600 hover:bg-gray-200{% endif %}">
      üìä Presupuesto
    </a>
    <a href="{% url 'educacion_financiera:calculators' %}?tab=retirement" 
       class="flex items-center gap-2 px-4 py-3 rounded-lg transition-all {% if tab == 'retirement' %}bg-white shadow-md text-blue-600 font-semibold{% else %}text-gray-600 hover:bg-gray-200{% endif %}">
      üèñÔ∏è Jubilaci√≥n
    </a>
    <a href="{% url 'educacion_financiera:calculators' %}?tab=investment" 
       class="flex items-center gap-2 px-4 py-3 rounded-lg transition-all {% if tab == 'investment' %}bg-white shadow-md text-blue-600 font-semibold{% else %}text-gray-600 hover:bg-gray-200{% endif %}">
      üìà Inversi√≥n
    </a>
  </div>
</div>

<!-- Contenedor Principal -->
<div class="grid lg:grid-cols-3 gap-8">
  <!-- Columna de Calculadora -->
  <div class="lg:col-span-2">
    
    <!-- Calculadora de Ahorros -->
    {% if tab == "savings" %}
    <div class="bg-white rounded-xl shadow-lg p-6 border">
      <div class="mb-6">
        <h3 class="text-xl font-bold text-gray-800 mb-2">üí∞ Calculadora de Ahorros</h3>
        <p class="text-gray-600">Descubre cu√°nto crecer√°n tus ahorros con el poder del inter√©s compuesto</p>
      </div>

      <form method="POST" class="space-y-6">
        {% csrf_token %}
        <input type="hidden" name="tab" value="savings">
        
        <div class="grid md:grid-cols-2 gap-6">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Capital Inicial ($)</label>
            <input type="number" name="initial" min="0" step="0.01" 
                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                   placeholder="10,000" required>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Aporte Mensual ($)</label>
            <input type="number" name="monthly" min="0" step="0.01" 
                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                   placeholder="500" required>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Tasa de Inter√©s Anual (%)</label>
            <input type="number" name="rate" min="0" step="0.1" max="100" 
                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                   placeholder="5.0" required>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Per√≠odo (a√±os)</label>
            <input type="number" name="years" min="1" max="50" 
                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                   placeholder="10" required>
          </div>
        </div>

        <button type="submit" class="w-full bg-gradient-to-r from-blue-600 to-purple-600 text-white font-semibold py-4 rounded-lg hover:from-blue-700 hover:to-purple-700 transition-all transform hover:scale-105">
          üßÆ Calcular Ahorros
        </button>
      </form>
    </div>

    <!-- Calculadora de Pr√©stamos -->
    {% elif tab == "loan" %}
    <div class="bg-white rounded-xl shadow-lg p-6 border">
      <div class="mb-6">
        <h3 class="text-xl font-bold text-gray-800 mb-2">üè¶ Calculadora de Pr√©stamos</h3>
        <p class="text-gray-600">Calcula tu pago mensual y el costo total de tu pr√©stamo</p>
      </div>

      <form method="POST" class="space-y-6">
        {% csrf_token %}
        <input type="hidden" name="tab" value="loan">
        
        <div class="grid md:grid-cols-2 gap-6">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Monto del Pr√©stamo ($)</label>
            <input type="number" name="amount" min="1" step="0.01" 
                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                   placeholder="200,000" required>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Tasa de Inter√©s Anual (%)</label>
            <input type="number" name="rate" min="0" step="0.1" max="100" 
                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                   placeholder="3.5" required>
          </div>
          <div class="md:col-span-2">
            <label class="block text-sm font-medium text-gray-700 mb-2">Plazo (a√±os)</label>
            <input type="number" name="years" min="1" max="50" 
                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                   placeholder="30" required>
          </div>
        </div>

        <button type="submit" class="w-full bg-gradient-to-r from-green-600 to-blue-600 text-white font-semibold py-4 rounded-lg hover:from-green-700 hover:to-blue-700 transition-all transform hover:scale-105">
          üè¶ Calcular Pr√©stamo
        </button>
      </form>
    </div>

    <!-- Calculadora de Presupuesto -->
    {% elif tab == "budget" %}
    <div class="bg-white rounded-xl shadow-lg p-6 border">
      <div class="mb-6">
        <h3 class="text-xl font-bold text-gray-800 mb-2">üìä Calculadora de Presupuesto</h3>
        <p class="text-gray-600">Analiza tu presupuesto seg√∫n la regla 50/30/20</p>
      </div>

      <form method="POST" class="space-y-6">
        {% csrf_token %}
        <input type="hidden" name="tab" value="budget">
        
        <div class="space-y-6">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Ingresos Mensuales ($)</label>
            <input type="number" name="income" min="0" step="0.01" 
                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                   placeholder="5,000" required>
          </div>
          
          <div class="grid md:grid-cols-3 gap-6">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Necesidades ($)</label>
              <input type="number" name="needs" min="0" step="0.01" 
                     class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                     placeholder="2,500">
              <p class="text-xs text-gray-500 mt-1">Vivienda, comida, transporte</p>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Deseos ($)</label>
              <input type="number" name="wants" min="0" step="0.01" 
                     class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                     placeholder="1,500">
              <p class="text-xs text-gray-500 mt-1">Entretenimiento, comidas fuera</p>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Ahorros ($)</label>
              <input type="number" name="savings" min="0" step="0.01" 
                     class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                     placeholder="1,000">
              <p class="text-xs text-gray-500 mt-1">Ahorro e inversiones</p>
            </div>
          </div>
        </div>

        <button type="submit" class="w-full bg-gradient-to-r from-purple-600 to-pink-600 text-white font-semibold py-4 rounded-lg hover:from-purple-700 hover:to-pink-700 transition-all transform hover:scale-105">
          üìä Analizar Presupuesto
        </button>
      </form>
    </div>

    <!-- Calculadora de Jubilaci√≥n -->
    {% elif tab == "retirement" %}
    <div class="bg-white rounded-xl shadow-lg p-6 border">
      <div class="mb-6">
        <h3 class="text-xl font-bold text-gray-800 mb-2">üèñÔ∏è Calculadora de Jubilaci√≥n</h3>
        <p class="text-gray-600">Planifica tu jubilaci√≥n y calcula cu√°nto necesitas ahorrar</p>
      </div>

      <form method="POST" class="space-y-6">
        {% csrf_token %}
        <input type="hidden" name="tab" value="retirement">
        
        <div class="grid md:grid-cols-2 gap-6">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Edad Actual</label>
            <input type="number" name="current_age" min="18" max="80" 
                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                   placeholder="30" required>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Edad de Jubilaci√≥n</label>
            <input type="number" name="retirement_age" min="50" max="80" 
                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                   placeholder="65" required>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Ahorros Actuales ($)</label>
            <input type="number" name="current_savings" min="0" step="0.01" 
                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                   placeholder="50,000" required>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Aporte Mensual ($)</label>
            <input type="number" name="monthly_contribution" min="0" step="0.01" 
                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                   placeholder="1,000" required>
          </div>
          <div class="md:col-span-2">
            <label class="block text-sm font-medium text-gray-700 mb-2">Retorno Anual Esperado (%)</label>
            <input type="number" name="expected_return" min="0" step="0.1" max="20" 
                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                   placeholder="7.0" required>
          </div>
        </div>

        <button type="submit" class="w-full bg-gradient-to-r from-orange-600 to-red-600 text-white font-semibold py-4 rounded-lg hover:from-orange-700 hover:to-red-700 transition-all transform hover:scale-105">
          üèñÔ∏è Calcular Jubilaci√≥n
        </button>
      </form>
    </div>

    <!-- Calculadora de Inversi√≥n -->
    {% elif tab == "investment" %}
    <div class="bg-white rounded-xl shadow-lg p-6 border">
      <div class="mb-6">
        <h3 class="text-xl font-bold text-gray-800 mb-2">üìà Calculadora de Inversi√≥n</h3>
        <p class="text-gray-600">Calcula el retorno de tus inversiones y analiza el ROI</p>
      </div>

      <form method="POST" class="space-y-6">
        {% csrf_token %}
        <input type="hidden" name="tab" value="investment">
        
        <div class="grid md:grid-cols-2 gap-6">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Inversi√≥n Inicial ($)</label>
            <input type="number" name="initial_investment" min="0" step="0.01" 
                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                   placeholder="10,000" required>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Inversi√≥n Mensual ($)</label>
            <input type="number" name="monthly_investment" min="0" step="0.01" 
                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                   placeholder="500" required>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Retorno Anual Esperado (%)</label>
            <input type="number" name="annual_return" min="0" step="0.1" max="50" 
                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                   placeholder="8.0" required>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Per√≠odo (a√±os)</label>
            <input type="number" name="investment_years" min="1" max="50" 
                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                   placeholder="15" required>
          </div>
        </div>

        <button type="submit" class="w-full bg-gradient-to-r from-green-600 to-teal-600 text-white font-semibold py-4 rounded-lg hover:from-green-700 hover:to-teal-700 transition-all transform hover:scale-105">
          üìà Calcular Inversi√≥n
        </button>
      </form>
    </div>
    {% endif %}
  </div>

  <!-- Columna de Resultados y IA -->
  <div class="lg:col-span-1">
    {% if result %}
      {% if not result.error %}
        <div class="bg-gradient-to-br from-blue-50 to-indigo-100 rounded-xl p-6 border border-blue-200 mb-6">
          <h4 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
            üìä Resultados
          </h4>
          
          <!-- Resultados espec√≠ficos por tipo -->
          {% if result.type == "savings" %}
            <div class="space-y-3">
              <div class="bg-white p-3 rounded-lg">
                <p class="text-sm text-gray-600">Valor Futuro</p>
                <p class="text-xl font-bold text-green-600">${{ result.future_value|floatformat:2 }}</p>
              </div>
              <div class="bg-white p-3 rounded-lg">
                <p class="text-sm text-gray-600">Total Contribuido</p>
                <p class="text-lg font-semibold text-blue-600">${{ result.total_contributed|floatformat:2 }}</p>
              </div>
              <div class="bg-white p-3 rounded-lg">
                <p class="text-sm text-gray-600">Intereses Ganados</p>
                <p class="text-lg font-semibold text-purple-600">${{ result.interest_earned|floatformat:2 }}</p>
              </div>
            </div>
          
          {% elif result.type == "loan" %}
            <div class="space-y-3">
              <div class="bg-white p-3 rounded-lg">
                <p class="text-sm text-gray-600">Pago Mensual</p>
                <p class="text-xl font-bold text-red-600">${{ result.monthly_payment|floatformat:2 }}</p>
              </div>
              <div class="bg-white p-3 rounded-lg">
                <p class="text-sm text-gray-600">Pago Total</p>
                <p class="text-lg font-semibold text-orange-600">${{ result.total_payment|floatformat:2 }}</p>
              </div>
              <div class="bg-white p-3 rounded-lg">
                <p class="text-sm text-gray-600">Inter√©s Total</p>
                <p class="text-lg font-semibold text-red-600">${{ result.total_interest|floatformat:2 }}</p>
              </div>
            </div>
          
          {% elif result.type == "budget" %}
            <div class="space-y-3">
              <div class="bg-white p-3 rounded-lg">
                <p class="text-sm text-gray-600">Balance</p>
                <p class="text-xl font-bold {% if result.remaining >= 0 %}text-green-600{% else %}text-red-600{% endif %}">
                  ${{ result.remaining|floatformat:2 }}
                </p>
              </div>
              <div class="bg-white p-3 rounded-lg">
                <p class="text-xs text-gray-500 mb-2">Distribuci√≥n Actual vs Recomendada</p>
                <div class="space-y-2">
                  <div class="flex justify-between text-sm">
                    <span>Necesidades:</span>
                    <span class="{% if result.needs_pct <= 50 %}text-green-600{% else %}text-red-600{% endif %}">
                      {{ result.needs_pct }}% (50%)
                    </span>
                  </div>
                  <div class="flex justify-between text-sm">
                    <span>Deseos:</span>
                    <span class="{% if result.wants_pct <= 30 %}text-green-600{% else %}text-red-600{% endif %}">
                      {{ result.wants_pct }}% (30%)
                    </span>
                  </div>
                  <div class="flex justify-between text-sm">
                    <span>Ahorros:</span>
                    <span class="{% if result.savings_pct >= 20 %}text-green-600{% else %}text-red-600{% endif %}">
                      {{ result.savings_pct }}% (20%)
                    </span>
                  </div>
                </div>
              </div>
            </div>
          
          {% elif result.type == "retirement" %}
            <div class="space-y-3">
              <div class="bg-white p-3 rounded-lg">
                <p class="text-sm text-gray-600">Valor al Jubilarse</p>
                <p class="text-xl font-bold text-green-600">${{ result.future_value|floatformat:2 }}</p>
              </div>
              <div class="bg-white p-3 rounded-lg">
                <p class="text-sm text-gray-600">Ingreso Mensual Estimado</p>
                <p class="text-lg font-semibold text-blue-600">${{ result.monthly_income_estimate|floatformat:2 }}</p>
              </div>
              <div class="bg-white p-3 rounded-lg">
                <p class="text-sm text-gray-600">A√±os hasta Jubilaci√≥n</p>
                <p class="text-lg font-semibold text-purple-600">{{ result.years_to_retirement }} a√±os</p>
              </div>
            </div>
          
          {% elif result.type == "investment" %}
            <div class="space-y-3">
              <div class="bg-white p-3 rounded-lg">
                <p class="text-sm text-gray-600">Valor Futuro</p>
                <p class="text-xl font-bold text-green-600">${{ result.future_value|floatformat:2 }}</p>
              </div>
              <div class="bg-white p-3 rounded-lg">
                <p class="text-sm text-gray-600">ROI</p>
                <p class="text-lg font-semibold text-blue-600">{{ result.roi_percentage|floatformat:1 }}%</p>
              </div>
              <div class="bg-white p-3 rounded-lg">
                <p class="text-sm text-gray-600">Ganancia</p>
                <p class="text-lg font-semibold text-purple-600">${{ result.total_return|floatformat:2 }}</p>
              </div>
            </div>
          {% endif %}
        </div>

        <!-- Explicaci√≥n de IA -->
        {% if ai_explanation %}
        <div class="bg-gradient-to-br from-purple-50 to-pink-100 rounded-xl p-6 border border-purple-200">
          <h4 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
            ü§ñ An√°lisis con IA
          </h4>
          <div class="ai-analysis text-sm text-gray-700 leading-relaxed">
            {{ ai_explanation|linebreaks }}
          </div>
        </div>
        {% else %}
        <div class="bg-yellow-50 rounded-xl p-6 border border-yellow-200">
          <h4 class="text-lg font-bold text-gray-800 mb-2 flex items-center gap-2">
            ‚ö†Ô∏è IA No Disponible
          </h4>
          <p class="text-gray-600 text-sm">El an√°lisis con IA no est√° disponible en este momento, pero tus c√°lculos son correctos.</p>
        </div>
        {% endif %}
      {% else %}
        <div class="bg-red-50 rounded-xl p-6 border border-red-200">
          <h4 class="text-lg font-bold text-red-800 mb-2">‚ùå Error</h4>
          <p class="text-red-600">{{ result.error }}</p>
        </div>
      {% endif %}
    {% else %}
      <!-- Informaci√≥n de la calculadora actual -->
      <div class="bg-gray-50 rounded-xl p-6 border">
        <h4 class="text-lg font-bold text-gray-800 mb-4">üí° Sobre esta calculadora</h4>
        
        {% if tab == "savings" %}
          <p class="text-gray-600 text-sm mb-4">La calculadora de ahorros usa la f√≥rmula de inter√©s compuesto para mostrar c√≥mo crecen tus ahorros con el tiempo.</p>
          <div class="space-y-2 text-xs text-gray-500">
            <p>‚Ä¢ El inter√©s compuesto hace que tu dinero crezca exponencialmente</p>
            <p>‚Ä¢ Los aportes regulares aceleran significativamente el crecimiento</p>
            <p>‚Ä¢ Comenzar temprano es clave para maximizar los resultados</p>
          </div>
        {% elif tab == "loan" %}
          <p class="text-gray-600 text-sm mb-4">Calcula tu pago mensual usando la f√≥rmula est√°ndar de amortizaci√≥n de pr√©stamos.</p>
          <div class="space-y-2 text-xs text-gray-500">
            <p>‚Ä¢ Tasas m√°s bajas = pagos mensuales menores</p>
            <p>‚Ä¢ Plazos m√°s largos = pagos menores pero m√°s inter√©s total</p>
            <p>‚Ä¢ Considera el costo total, no solo el pago mensual</p>
          </div>
        {% elif tab == "budget" %}
          <p class="text-gray-600 text-sm mb-4">Analiza tu presupuesto usando la popular regla 50/30/20 para una distribuci√≥n saludable del dinero.</p>
          <div class="space-y-2 text-xs text-gray-500">
            <p>‚Ä¢ 50% para necesidades (vivienda, comida, transporte)</p>
            <p>‚Ä¢ 30% para deseos (entretenimiento, hobbies)</p>
            <p>‚Ä¢ 20% para ahorros e inversiones</p>
          </div>
        {% elif tab == "retirement" %}
          <p class="text-gray-600 text-sm mb-4">Planifica tu jubilaci√≥n usando proyecciones de crecimiento de inversiones y la regla del 4%.</p>
          <div class="space-y-2 text-xs text-gray-500">
            <p>‚Ä¢ La regla del 4% sugiere retirar 4% anualmente en jubilaci√≥n</p>
            <p>‚Ä¢ Comenzar temprano es crucial por el inter√©s compuesto</p>
            <p>‚Ä¢ Considera la inflaci√≥n en tus planes a largo plazo</p>
          </div>
        {% elif tab == "investment" %}
          <p class="text-gray-600 text-sm mb-4">Calcula el retorno de tus inversiones y analiza si cumplen tus objetivos financieros.</p>
          <div class="space-y-2 text-xs text-gray-500">
            <p>‚Ä¢ El ROI te ayuda a comparar diferentes inversiones</p>
            <p>‚Ä¢ Considera los riesgos junto con los retornos esperados</p>
            <p>‚Ä¢ La diversificaci√≥n reduce el riesgo total</p>
          </div>
        {% endif %}
      </div>
    {% endif %}
  </div>
</div>

<style>
.prose {
  max-width: none;
}
.prose p {
  margin-bottom: 0.75rem;
  line-height: 1.6;
}
.prose h4 {
  margin-top: 1rem;
  margin-bottom: 0.5rem;
  font-weight: 600;
}

.ai-analysis {
  line-height: 1.6;
}

.ai-analysis p {
  margin-bottom: 0.5rem;
}

/* Formatear listas numeradas de la IA */
.ai-analysis p:contains("1."),
.ai-analysis p:contains("2."),
.ai-analysis p:contains("3.") {
  margin-bottom: 0.75rem;
  padding-left: 0.5rem;
  border-left: 3px solid #a855f7;
  background-color: rgba(168, 85, 247, 0.05);
  padding: 0.5rem;
  border-radius: 0.375rem;
}
</style>
{% endblock %}
